<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAPE MARKET</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        :root {
            --primary: #8A2BE2;
            --primary-dark: #5D00A3;
            --bg-dark: #0A0A0F;
            --bg-card: #1A1A24;
            --text: #FFFFFF;
            --text-secondary: #B0B0C0;
            --success: #00CC88;
            --danger: #FF3366;
        }
        body { background: var(--bg-dark); color: var(--text); }
        
        .age-gate {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark); z-index: 1000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }
        .age-gate.hidden { display: none; }
        .age-title { font-size: 28px; margin-bottom: 10px; color: var(--primary); }
        .age-buttons { display: flex; gap: 15px; width: 100%; max-width: 300px; }
        .age-btn { flex: 1; padding: 15px; border: none; border-radius: 15px; font-size: 16px; cursor: pointer; }
        .age-yes { background: var(--success); color: white; }
        .age-no { background: var(--danger); color: white; }
        
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: var(--bg-dark); display: none; }
        .app-container.active { display: block; }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px 15px; text-align: center;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        
        .nav-tabs {
            display: flex; background: var(--bg-card); margin: 15px;
            border-radius: 15px; overflow: hidden;
        }
        .nav-tab {
            flex: 1; text-align: center; padding: 15px;
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer;
        }
        .nav-tab.active { color: var(--text); background: rgba(138, 43, 226, 0.15); }
        
        .categories { padding: 15px; }
        .categories-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; margin-top: 15px;
        }
        .category-card {
            background: var(--bg-card); border-radius: 12px;
            padding: 15px; text-align: center; cursor: pointer;
        }
        .category-card.active { background: rgba(138, 43, 226, 0.2); }
        
        .products-section { padding: 15px; }
        .section-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 15px;
        }
        .add-product-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; border: none; border-radius: 50px;
            padding: 10px 20px; cursor: pointer;
        }
        
        .products-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .product-card {
            background: var(--bg-card); border-radius: 15px;
            overflow: hidden;
        }
        .product-image {
            width: 100%; height: 150px;
            background: linear-gradient(45deg, var(--primary-dark), var(--primary));
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: white;
        }
        .product-content { padding: 15px; }
        .product-title { font-size: 16px; margin-bottom: 8px; }
        .product-price { color: var(--success); font-size: 20px; margin-bottom: 10px; }
        .product-actions { display: flex; gap: 10px; }
        .action-btn {
            flex: 1; padding: 8px; border-radius: 10px;
            border: none; cursor: pointer;
        }
        .buy-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .profile-section { padding: 15px; }
        .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px; padding: 25px; text-align: center;
            margin-bottom: 20px;
        }
        .user-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid white; margin: 0 auto 15px;
            background: var(--bg-card); display: flex;
            align-items: center; justify-content: center; font-size: 32px;
        }
        
        .form-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 15, 0.95); z-index: 1001;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .form-overlay.active { display: flex; }
        .add-form {
            background: var(--bg-card); border-radius: 20px;
            padding: 25px; width: 100%; max-width: 450px;
        }
        .form-group { margin-bottom: 20px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px; color: var(--text);
        }
        .form-actions { display: flex; gap: 15px; margin-top: 25px; }
        .form-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; cursor: pointer; }
        .submit-btn { background: var(--primary); color: white; }
        .cancel-btn { background: rgba(255, 255, 255, 0.1); color: var(--text); }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            background: var(--bg-card); border-radius: 12px;
            transform: translateX(150%); transition: transform 0.3s;
            z-index: 1002;
        }
        .notification.show { transform: translateX(0); }
        
        .loading { text-align: center; padding: 40px; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div id="ageGate" class="age-gate">
        <h1 class="age-title">–î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</h1>
        <p class="age-text">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç</p>
        <div class="age-buttons">
            <button id="ageYes" class="age-btn age-yes">–î–ê, –ú–ù–ï –ï–°–¢–¨ 18</button>
            <button id="ageNo" class="age-btn age-no">–ù–ï–¢, –ú–ù–ï –ù–ï–¢ 18</button>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>VAPE MARKET</h1>
            <div class="header-subtitle">–ü–æ–∫—É–ø–∞–π –∏ –ø—Ä–æ–¥–∞–≤–∞–π –±–µ–∑–æ–ø–∞—Å–Ω–æ</div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="market">üõí –ú–∞—Ä–∫–µ—Ç</button>
            <button class="nav-tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <div id="marketTab">
            <div class="categories">
                <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>
            
            <div class="products-section">
                <div class="section-header">
                    <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
                    <button class="add-product-btn" id="openAddForm">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div class="products-grid" id="productsGrid"></div>
            </div>
        </div>

        <div id="profileTab" style="display: none;">
            <div class="profile-section">
                <div class="profile-header">
                    <div class="user-avatar" id="userAvatar">üë§</div>
                    <h2 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                    <div id="userTelegram">@username</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div class="category-card">
                        <div id="myProductsCount">0</div>
                        <div>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>
                    </div>
                    <div class="category-card">
                        <div id="totalViews">0</div>
                        <div>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                    </div>
                    <div class="category-card">
                        <div id="totalLikes">0</div>
                        <div>–õ–∞–π–∫–∏</div>
                    </div>
                </div>
                
                <h2>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
                <div class="products-grid" id="myProductsGrid"></div>
            </div>
        </div>

        <div class="form-overlay" id="addFormOverlay">
            <div class="add-form">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
                <form id="addProductForm">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                        <input type="text" class="form-input" name="title" required placeholder="GeekVape Aegis">
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-select" name="category" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option value="–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                            <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
                            <option value="Pod-—Å–∏—Å—Ç–µ–º—ã">Pod-—Å–∏—Å—Ç–µ–º—ã</option>
                            <option value="–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ">–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ</option>
                            <option value="–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type="number" class="form-input" name="price" required placeholder="3500">
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-textarea" name="description" placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–æ–≤–∞—Ä..." rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="form-btn cancel-btn" id="cancelAddForm">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="form-btn submit-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="notification" id="notification"></div>
        
        <footer style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">
            <p>¬© 2024 VAPE MARKET | –¢–æ–ª—å–∫–æ –¥–ª—è –ª–∏—Ü —Å—Ç–∞—Ä—à–µ 18 –ª–µ—Ç</p>
        </footer>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const SUPABASE_URL = 'https://kawspxlxbncaihbnoetc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imthd3NweGx4Ym5jYWloYm5vZXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDkyMTIsImV4cCI6MjA4MjE4NTIxMn0.ULXwvlG8rl6iMO6MLgG0CbE08flNT-eqethEQgRX0n4';
        
        let supabase;
        let currentUser = {
            id: 'user_' + Date.now(),
            name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            username: 'user'
        };
        let products = [];
        
        // ========== –í–û–ó–†–ê–°–¢–ù–´–ï –í–û–†–û–¢–ê ==========
        document.addEventListener('DOMContentLoaded', function() {
            const ageGate = document.getElementById('ageGate');
            const appContainer = document.getElementById('appContainer');
            
            if (localStorage.getItem('ageConfirmed')) {
                ageGate.style.display = 'none';
                appContainer.classList.add('active');
                initApp();
            } else {
                document.getElementById('ageYes').addEventListener('click', function() {
                    localStorage.setItem('ageConfirmed', 'true');
                    ageGate.style.display = 'none';
                    appContainer.classList.add('active');
                    initApp();
                });
                
                document.getElementById('ageNo').addEventListener('click', function() {
                    alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 18 –ª–µ—Ç.');
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.close();
                    }
                });
            }
        });
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
        async function initApp() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const user = Telegram.WebApp.initDataUnsafe?.user;
                if (user) {
                    currentUser = {
                        id: user.id.toString(),
                        name: user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        username: user.username || `user_${user.id}`
                    };
                    console.log('Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Supabase:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                return;
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            setupNavigation();
            setupForm();
            loadCategories();
            loadProducts();
            updateProfile();
            
            showNotification('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!');
        }
        
        // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        function setupNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const marketTab = document.getElementById('marketTab');
            const profileTab = document.getElementById('profileTab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.dataset.tab === 'market') {
                        marketTab.style.display = 'block';
                        profileTab.style.display = 'none';
                    } else {
                        marketTab.style.display = 'none';
                        profileTab.style.display = 'block';
                        updateProfile();
                    }
                });
            });
        }
        
        // ========== –ö–ê–¢–ï–ì–û–†–ò–ò ==========
        function loadCategories() {
            const categories = [
                { id: '–í—Å–µ', name: '–í—Å–µ', icon: 'üì¶' },
                { id: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', name: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', icon: 'üì±' },
                { id: '–ñ–∏–¥–∫–æ—Å—Ç–∏', name: '–ñ–∏–¥–∫–æ—Å—Ç–∏', icon: 'üíß' },
                { id: 'Pod-—Å–∏—Å—Ç–µ–º—ã', name: 'Pod-—Å–∏—Å—Ç–µ–º—ã', icon: 'üîã' },
                { id: '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ', name: '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ', icon: 'üö¨' },
                { id: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', name: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', icon: '‚öôÔ∏è' }
            ];
            
            const container = document.getElementById('categoriesGrid');
            container.innerHTML = '';
            
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'category-card';
                div.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">${cat.icon}</div>
                    <div style="font-weight: bold;">${cat.name}</div>
                    <div style="color: var(--text-secondary); font-size: 12px;" id="cat-count-${cat.id}">0</div>
                `;
                
                div.addEventListener('click', function() {
                    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    filterProducts(cat.id);
                });
                
                if (cat.id === '–í—Å–µ') div.classList.add('active');
                
                container.appendChild(div);
            });
        }
        
        // ========== –ó–ê–ì–†–£–ó–ö–ê –¢–û–í–ê–†–û–í ==========
        async function loadProducts() {
            const container = document.getElementById('productsGrid');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
            
            try {
                const { data, error } = await supabase
                    .from('mini_app_market')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                products = data || [];
                filterProducts('–í—Å–µ');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                container.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
            }
        }
        
        // ========== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –¢–û–í–ê–†–û–í ==========
        function filterProducts(category) {
            const container = document.getElementById('productsGrid');
            
            let filteredProducts = products;
            if (category && category !== '–í—Å–µ') {
                filteredProducts = products.filter(p => p.category === category);
            }
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div class="empty-state">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                updateCategoryCounts();
                return;
            }
            
            container.innerHTML = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="product-image">${getCategoryIcon(product.category)}</div>
                    <div class="product-content">
                        <div class="product-title">${product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                        <div class="product-price">${product.price || 0} ‚ÇΩ</div>
                        <div style="background: rgba(138, 43, 226, 0.2); color: #9B4DFF; padding: 4px 10px; border-radius: 20px; font-size: 12px; display: inline-block; margin-bottom: 10px;">
                            ${product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">
                            ${product.user_name || '–ê–Ω–æ–Ω–∏–º'}
                        </div>
                        <div class="product-actions">
                            <button class="action-btn buy-btn" onclick="contactSeller('${product.telegram_username || product.user_name || ''}', '${product.title}')">
                                –ù–∞–ø–∏—Å–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateCategoryCounts();
        }
        
        function getCategoryIcon(category) {
            const icons = {
                '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞': 'üì±',
                '–ñ–∏–¥–∫–æ—Å—Ç–∏': 'üíß',
                'Pod-—Å–∏—Å—Ç–µ–º—ã': 'üîã',
                '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ': 'üö¨',
                '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏': '‚öôÔ∏è'
            };
            return icons[category] || 'üì¶';
        }
        
        function updateCategoryCounts() {
            const categories = ['–í—Å–µ', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '–ñ–∏–¥–∫–æ—Å—Ç–∏', 'Pod-—Å–∏—Å—Ç–µ–º—ã', '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'];
            
            categories.forEach(cat => {
                const countElement = document.getElementById(`cat-count-${cat}`);
                if (countElement) {
                    let count = 0;
                    if (cat === '–í—Å–µ') {
                        count = products.length;
                    } else {
                        count = products.filter(p => p.category === cat).length;
                    }
                    countElement.textContent = count;
                }
            });
        }
        
        // ========== –ü–†–û–§–ò–õ–¨ ==========
        function updateProfile() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userTelegram').textContent = '@' + currentUser.username;
            
            const myProducts = products.filter(p => p.user_telegram_id === currentUser.id);
            document.getElementById('myProductsCount').textContent = myProducts.length;
            
            const totalViews = myProducts.reduce((sum, p) => sum + (p.views_count || 0), 0);
            document.getElementById('totalViews').textContent = totalViews;
            
            const totalLikes = myProducts.reduce((sum, p) => sum + (p.likes_count || 0), 0);
            document.getElementById('totalLikes').textContent = totalLikes;
            
            // –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã
            const myProductsContainer = document.getElementById('myProductsGrid');
            if (myProducts.length === 0) {
                myProductsContainer.innerHTML = '<div class="empty-state">–£ –≤–∞—Å –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>';
                return;
            }
            
            myProductsContainer.innerHTML = myProducts.map(product => `
                <div class="product-card">
                    <div class="product-image">${getCategoryIcon(product.category)}</div>
                    <div class="product-content">
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">${product.price} ‚ÇΩ</div>
                        <div class="product-actions">
                            <button class="action-btn buy-btn" style="background: #FFAA00;" onclick="editProduct('${product.id}')">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="action-btn" style="background: #FF3366; color: white;" onclick="deleteProduct('${product.id}')">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ========== –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø ==========
        function setupForm() {
            const openBtn = document.getElementById('openAddForm');
            const overlay = document.getElementById('addFormOverlay');
            const cancelBtn = document.getElementById('cancelAddForm');
            const form = document.getElementById('addProductForm');
            
            openBtn.addEventListener('click', function() {
                overlay.classList.add('active');
            });
            
            cancelBtn.addEventListener('click', function() {
                overlay.classList.remove('active');
                form.reset();
            });
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const productData = {
                    title: formData.get('title'),
                    category: formData.get('category'),
                    price: parseInt(formData.get('price')) || 0,
                    description: formData.get('description'),
                    user_name: currentUser.name,
                    telegram_username: currentUser.username,
                    user_telegram_id: currentUser.id,
                    is_active: true,
                    likes_count: 0,
                    views_count: 0,
                    deals_count: 0,
                    created_at: new Date().toISOString()
                };
                
                const submitBtn = form.querySelector('.submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '–ü—É–±–ª–∏–∫—É—é...';
                submitBtn.disabled = true;
                
                try {
                    const { error } = await supabase
                        .from('mini_app_market')
                        .insert([productData]);
                    
                    if (error) throw error;
                    
                    showNotification('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
                    overlay.classList.remove('active');
                    form.reset();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    await loadProducts();
                    updateProfile();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                    form.reset();
                }
            });
        }
        
        // ========== –î–ï–ô–°–¢–í–ò–Ø –° –¢–û–í–ê–†–ê–ú–ò ==========
        function contactSeller(username, productTitle) {
            if (username) {
                const cleanUsername = username.replace('@', '');
                const message = encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç–æ–≤–∞—Ä: "${productTitle}"`);
                
                // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –≤ Telegram WebApp
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.openTelegramLink(`https://t.me/${cleanUsername}?text=${message}`);
                } else {
                    // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
                    window.open(`https://t.me/${cleanUsername}?text=${message}`, '_blank');
                }
                showNotification('–û—Ç–∫—Ä—ã–≤–∞—é —á–∞—Ç...');
            } else {
                showNotification('‚ùå –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ–¥–∞–≤—Ü–∞ –Ω–µ —É–∫–∞–∑–∞–Ω—ã');
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            
            try {
                const { error } = await supabase
                    .from('mini_app_market')
                    .update({ is_active: false })
                    .eq('id', productId);
                
                if (error) throw error;
                
                showNotification('‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                await loadProducts();
                updateProfile();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }
        
        function editProduct(productId) {
            showNotification('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
