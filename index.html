<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAPE MARKET</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        
        body { 
            background: linear-gradient(135deg, #8A2BE2, #5D00A3); 
            color: white; 
            min-height: 100vh; 
        }
        
        /* –ü–ª–∞—à–∫–∞ 18+ */
        #ageGate {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #8A2BE2, #5D00A3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            z-index: 1000;
        }
        
        .age-icon { font-size: 60px; margin-bottom: 20px; }
        .age-title { font-size: 28px; margin-bottom: 10px; font-weight: bold; }
        .age-text { margin-bottom: 30px; opacity: 0.9; }
        
        .age-buttons {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .age-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #ageYes { background: #00CC88; color: white; }
        #ageNo { background: #FF3366; color: white; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
        #appContainer {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .nav-tab.active {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
        }
        
        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
        }
        
        .category-card.active {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
        }
        
        /* –¢–æ–≤–∞—Ä—ã */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .product-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
        }
        
        .product-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #00CC88;
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .add-product-btn {
            background: white;
            color: #8A2BE2;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .buy-btn {
            background: #00CC88;
            color: white;
        }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-header {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        /* –§–æ—Ä–º–∞ */
        #addFormOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
        }
        
        .add-form {
            background: #1A1A24;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 10px;
            background: #222;
            color: white;
        }
        
        .form-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            width: 48%;
        }
        
        .submit-btn {
            background: #00CC88;
            color: white;
        }
        
        .cancel-btn {
            background: #666;
            color: white;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1A1A24;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00CC88;
            display: none;
            z-index: 1002;
        }
    </style>
</head>
<body>
    <!-- –ü–ª–∞—à–∫–∞ 18+ -->
    <div id="ageGate">
        <div class="age-icon">üö´</div>
        <h1 class="age-title">–î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</h1>
        <p class="age-text">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ VAPE MARKET –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç</p>
        <div class="age-buttons">
            <button id="ageYes" class="age-btn">–î–ê, –ú–ù–ï –ï–°–¢–¨ 18</button>
            <button id="ageNo" class="age-btn">–ù–ï–¢, –ú–ù–ï –ù–ï–¢ 18</button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="appContainer">
        <!-- –®–∞–ø–∫–∞ -->
        <header class="header">
            <h1>VAPE MARKET</h1>
            <p>–ü–æ–∫—É–ø–∞–π –∏ –ø—Ä–æ–¥–∞–≤–∞–π –±–µ–∑–æ–ø–∞—Å–Ω–æ</p>
        </header>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="market">üõí –ú–∞—Ä–∫–µ—Ç</button>
            <button class="nav-tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <!-- –ú–∞—Ä–∫–µ—Ç -->
        <div id="marketTab">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
            <div class="categories-grid" id="categoriesGrid">
                <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
            </div>

            <!-- –¢–æ–≤–∞—Ä—ã -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>–¢–æ–≤–∞—Ä—ã</h3>
                <button class="add-product-btn" id="openAddForm">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="products-grid" id="productsGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div id="profileTab" style="display: none;">
            <div class="profile-header">
                <div style="width: 80px; height: 80px; background: white; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #8A2BE2;">üë§</div>
                <h2 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                <p id="userTelegram">@username</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="myProductsCount">0</div>
                    <div>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalViews">0</div>
                    <div>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalLikes">0</div>
                    <div>–õ–∞–π–∫–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDeals">0</div>
                    <div>–°–¥–µ–ª–∫–∏</div>
                </div>
            </div>

            <h3>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
            <div class="products-grid" id="myProductsGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                    –£ –≤–∞—Å –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div id="addFormOverlay">
            <div class="add-form">
                <h2 style="text-align: center; margin-bottom: 20px;">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <form id="addProductForm">
                    <input type="text" class="form-input" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required>
                    <select class="form-input" name="category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option value="–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                        <option value="–ñ–∏–¥–∫–æ—Å—Ç–∏">–ñ–∏–¥–∫–æ—Å—Ç–∏</option>
                        <option value="–ø–æ–¥-—Å–∏—Å—Ç–µ–º–∞">Pod-—Å–∏—Å—Ç–µ–º—ã</option>
                        <option value="–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ</option>
                        <option value="—Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</option>
                    </select>
                    <input type="number" class="form-input" name="price" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" required>
                    <textarea class="form-input" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
                    <input type="url" class="form-input" name="image_url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button type="button" class="form-btn cancel-btn" id="cancelAddForm">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="form-btn submit-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
        <div class="notification" id="notification"></div>

        <!-- –ü–æ–¥–≤–∞–ª -->
        <footer style="text-align: center; margin-top: 40px; padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px;">
            <p>¬© 2024 VAPE MARKET | –¢–æ–ª—å–∫–æ –¥–ª—è –ª–∏—Ü —Å—Ç–∞—Ä—à–µ 18 –ª–µ—Ç</p>
            <p>–í—Å–µ —Å–¥–µ–ª–∫–∏ —á–µ—Ä–µ–∑ Telegram</p>
        </footer>
    </div>

    <script>
        // ===== –ü–†–û–°–¢–û–ô –ö–û–î –ë–ï–ó –û–®–ò–ë–û–ö =====
        
        // 1. –ü–õ–ê–®–ö–ê 18+
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            
            const ageGate = document.getElementById('ageGate');
            const ageYes = document.getElementById('ageYes');
            const ageNo = document.getElementById('ageNo');
            const appContainer = document.getElementById('appContainer');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ª–∏ —É–∂–µ –≤–æ–∑—Ä–∞—Å—Ç
            if (localStorage.getItem('ageConfirmed') === 'true') {
                ageGate.style.display = 'none';
                appContainer.style.display = 'block';
                initApp();
            }
            
            // –ö–Ω–æ–ø–∫–∞ –î–ê
            ageYes.addEventListener('click', function() {
                console.log('–ö–Ω–æ–ø–∫–∞ "–î–ê" –Ω–∞–∂–∞—Ç–∞');
                localStorage.setItem('ageConfirmed', 'true');
                ageGate.style.display = 'none';
                appContainer.style.display = 'block';
                showNotification('‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω!');
                initApp();
            });
            
            // –ö–Ω–æ–ø–∫–∞ –ù–ï–¢
            ageNo.addEventListener('click', function() {
                showNotification('üö´ –í–∞–º –Ω–µ—Ç 18 –ª–µ—Ç. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.');
                setTimeout(() => location.reload(), 3000);
            });
        });
        
        // 2. –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
        let currentUser = {
            id: 'user_' + Date.now(),
            name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            username: 'user'
        };
        
        async function initApp() {
            console.log('–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            setupNavigation();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã
            setupForm();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            loadCategories();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
            await loadProducts();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            updateProfile();
            
            showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VAPE MARKET!');
        }
        
        function setupNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const marketTab = document.getElementById('marketTab');
            const profileTab = document.getElementById('profileTab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
                    tabs.forEach(t => t.classList.remove('active'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
                    this.classList.add('active');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                    const tabName = this.dataset.tab;
                    marketTab.style.display = tabName === 'market' ? 'block' : 'none';
                    profileTab.style.display = tabName === 'profile' ? 'block' : 'none';
                    
                    if (tabName === 'profile') {
                        updateProfile();
                    }
                });
            });
        }
        
        function loadCategories() {
            const categories = [
                { id: '–í—Å–µ', name: '–í—Å–µ', count: 0 },
                { id: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', name: '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', count: 0 },
                { id: '–ñ–∏–¥–∫–æ—Å—Ç–∏', name: '–ñ–∏–¥–∫–æ—Å—Ç–∏', count: 0 },
                { id: '–ø–æ–¥-—Å–∏—Å—Ç–µ–º–∞', name: 'Pod-—Å–∏—Å—Ç–µ–º—ã', count: 0 },
                { id: '–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', name: '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ', count: 0 },
                { id: '—Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', name: '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', count: 0 }
            ];
            
            const container = document.getElementById('categoriesGrid');
            container.innerHTML = categories.map(cat => `
                <div class="category-card" data-category="${cat.id}" onclick="filterProducts('${cat.id}')">
                    <div style="font-size: 24px; margin-bottom: 5px;">üì¶</div>
                    <div>${cat.name}</div>
                    <div style="font-size: 12px; opacity: 0.7;">${cat.count}</div>
                </div>
            `).join('');
        }
        
        let allProducts = [];
        let myProducts = [];
        
        async function loadProducts() {
            try {
                // URL —Ç–≤–æ–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                const url = 'https://kawspxlxbncaihbnoetc.supabase.co/rest/v1/mini_app_market?select=*';
                const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imthd3NweGx4Ym5jYWloYm5vZXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDkyMTIsImV4cCI6MjA4MjE4NTIxMn0.ULXwvlG8rl6iMO6MLgG0CbE08flNT-eqethEQgRX0n4';
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });
                
                const data = await response.json();
                allProducts = data || [];
                myProducts = allProducts.filter(p => p.user_telegram_id === currentUser.id);
                
                showProducts(allProducts);
                updateCategoryCounts();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
                    </div>
                `;
            }
        }
        
        function showProducts(products) {
            const container = document.getElementById('productsGrid');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-title">${product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                    <div style="background: rgba(138,43,226,0.2); display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; margin: 5px 0;">
                        ${product.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
                    </div>
                    <div class="product-price">${product.price || 0} ‚ÇΩ</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 10px;">
                        üë§ ${product.user_name || '–ê–Ω–æ–Ω–∏–º'} | üëÅÔ∏è ${product.views_count || 0} | ‚ù§Ô∏è ${product.likes_count || 0}
                    </div>
                    <button class="action-btn buy-btn" onclick="buyProduct('${product.id}', '${product.telegram_username || ''}')">
                        –ö—É–ø–∏—Ç—å
                    </button>
                    <button class="action-btn" style="background: #666; color: white;" onclick="likeProduct('${product.id}')">
                        ‚ù§Ô∏è ${product.likes_count || 0}
                    </button>
                </div>
            `).join('');
        }
        
        function filterProducts(category) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            let filtered = allProducts;
            if (category !== '–í—Å–µ') {
                filtered = allProducts.filter(p => p.category === category);
            }
            
            showProducts(filtered);
        }
        
        function updateCategoryCounts() {
            const categories = ['–í—Å–µ', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ø–æ–¥-—Å–∏—Å—Ç–µ–º–∞', '–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '—Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'];
            
            categories.forEach(cat => {
                let count = 0;
                if (cat === '–í—Å–µ') {
                    count = allProducts.length;
                } else {
                    count = allProducts.filter(p => p.category === cat).length;
                }
                
                const card = document.querySelector(`[data-category="${cat}"]`);
                if (card) {
                    card.querySelector('div:last-child').textContent = count;
                }
            });
        }
        
        function updateProfile() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userTelegram').textContent = '@' + currentUser.username;
            document.getElementById('myProductsCount').textContent = myProducts.length;
            
            const totalViews = myProducts.reduce((sum, p) => sum + (p.views_count || 0), 0);
            const totalLikes = myProducts.reduce((sum, p) => sum + (p.likes_count || 0), 0);
            const totalDeals = myProducts.reduce((sum, p) => sum + (p.deals_count || 0), 0);
            
            document.getElementById('totalViews').textContent = totalViews;
            document.getElementById('totalLikes').textContent = totalLikes;
            document.getElementById('totalDeals').textContent = totalDeals;
            
            // –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            const myContainer = document.getElementById('myProductsGrid');
            if (myProducts.length === 0) {
                myContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                        –£ –≤–∞—Å –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </div>
                `;
            } else {
                myContainer.innerHTML = myProducts.map(product => `
                    <div class="product-card">
                        <div class="product-title">${product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                        <div class="product-price">${product.price || 0} ‚ÇΩ</div>
                        <div style="font-size: 12px; opacity: 0.8;">
                            üëÅÔ∏è ${product.views_count || 0} | ‚ù§Ô∏è ${product.likes_count || 0} | ü§ù ${product.deals_count || 0}
                        </div>
                        <button class="action-btn buy-btn" onclick="editProduct('${product.id}')" style="margin-top: 10px;">
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                `).join('');
            }
        }
        
        function setupForm() {
            const openBtn = document.getElementById('openAddForm');
            const overlay = document.getElementById('addFormOverlay');
            const cancelBtn = document.getElementById('cancelAddForm');
            const form = document.getElementById('addProductForm');
            
            openBtn.addEventListener('click', () => {
                overlay.style.display = 'flex';
            });
            
            cancelBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
            });
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const productData = {
                    title: formData.get('title'),
                    category: formData.get('category'),
                    price: parseInt(formData.get('price')) || 0,
                    description: formData.get('description') || '',
                    image_url: formData.get('image_url') || null,
                    user_name: currentUser.name,
                    telegram_username: currentUser.username,
                    user_telegram_id: currentUser.id,
                    is_active: true,
                    views_count: 0,
                    likes_count: 0,
                    deals_count: 0
                };
                
                try {
                    const url = 'https://kawspxlxbncaihbnoetc.supabase.co/rest/v1/mini_app_market';
                    const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imthd3NweGx4Ym5jYWloYm5vZXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDkyMTIsImV4cCI6MjA4MjE4NTIxMn0.ULXwvlG8rl6iMO6MLgG0CbE08flNT-eqethEQgRX0n4';
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': key,
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify([productData])
                    });
                    
                    if (response.ok) {
                        showNotification('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
                        overlay.style.display = 'none';
                        this.reset();
                        await loadProducts();
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
                }
            });
        }
        
        // 3. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function buyProduct(productId, telegram) {
            if (telegram) {
                window.open(`https://t.me/${telegram.replace('@', '')}`, '_blank');
                showNotification('–û—Ç–∫—Ä—ã–≤–∞—é Telegram...');
            } else {
                showNotification('–ü—Ä–æ–¥–∞–≤–µ—Ü –Ω–µ —É–∫–∞–∑–∞–ª Telegram');
            }
        }
        
        function likeProduct(productId) {
            showNotification('–õ–∞–π–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
        }
        
        function editProduct(productId) {
            showNotification('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick
        window.filterProducts = filterProducts;
        window.buyProduct = buyProduct;
        window.likeProduct = likeProduct;
        window.editProduct = editProduct;
    </script>
</body>
</html>
